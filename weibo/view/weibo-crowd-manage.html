<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/icomoon.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/app-form.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/mui/mui.view.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/app/base.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/pull-top-tips.css" />
		<style type="text/css">
			.item-right-text{
			    position: absolute;
				right: 5px;
			    top: 25px;
			    font-size: 12px;
			}
			.crowd-logo{
				margin-top: 30px;
			}
			#member_page .mui-page-content .mui-table-view,
			#invite_page .mui-page-content .mui-table-view{
				margin: 0;
			}
			#invite_page .mui-table-view-cell.mui-active,
			#member_check_page .mui-table-view-cell.mui-active{
				background-color: #FFF;
			}
			.invite-btn{
				padding: 15px;
				font-size: 25px;
				color: #1abc9c;
			}
			.user-title{
				display: inline-block;
				max-width: 80%;
			}
			.mui-popover-action li[data-perm='2']{
				display: none !important;
			}
			.mui-collapse-content{
				background-color: #efeff4 !important;
			}
			.mui-table-view-cell:after{
				height: 1px !important;
			}
		</style>
	</head>

		<body class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="manage_page" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="center_page" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 id="crowd_title" class="mui-center mui-title"></h1>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
		                    <li class="mui-table-view-cell">
		                        <a href="#notice_page" class="mui-navigate-right">
		                        	修改公告
		                        </a>
		                    </li>
		                    <li class="mui-table-view-cell">
		                        <a href="#info_page" class="mui-navigate-right">
		                        	修改资料
		                        </a>
		                    </li>
		               </ul>
		                <ul class="mui-table-view">
		                    <li class="mui-table-view-cell">
		                        <a href="#member_check_page" class="mui-navigate-right">
		                        	成员审核
		                        </a>
		                    </li>
		                    <li class="mui-table-view-cell">
		                        <a href="#member_page" class="mui-navigate-right">
		                        	成员管理
		                        </a>
		                    </li>
		                    <li class="mui-table-view-cell">
		                        <a href="#invite_page" class="mui-navigate-right">
		                           	邀请好友
		                        </a>
		                    </li>
		                    <li id="dismiss" class="mui-table-view-cell">
		                        <a class="mui-navigate-right">
		                           	解散圈子
		                        </a>
		                    </li>
		                </ul>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<!--单页面结束-->

		<!--公告页面-->
		<div id="notice_page" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">修改公告</h1>
				<div id="notice_submit_btn" class="mui-icon text-btn base-head-btn base-ok-color mui-pull-right">发布</div>
			</div>
			<div class="mui-page-content">
				<textarea id="notice_content_view" class="app-form-textarea" rows="5" placeholder="公告内容"></textarea>
			</div>
		</div>
		<!--资料页面-->
		<div id="info_page" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">修改资料</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="mui-text-center">
	                        <img id="set_logo" class="crowd-logo base-img-mid base-round" src="../../images/app-logo.png">
						</div>
						<ul class="mui-table-view">
							<li id="set_title" class="mui-table-view-cell">
		                        <a class="mui-navigate-right">标题
		                       		<span data-name="text" class="mui-pull-right">四国以</span>
		                        </a>
		                    </li>
							<li id="set_type" class="mui-table-view-cell mui-collapse">
		                        <a class="mui-navigate-right">类型
		                        	<span id="type_text" data-name="text" class="mui-pull-right"></span>
		                        </a>
		                        <div class="mui-collapse-content">
		                        	<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>私密</label>
										<input data-type="1" name="radio_type" type="radio">
									</div>
									<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>公开</label>
										<input data-type="0" name="radio_type" type="radio">
									</div>
		                        </div>
		                    </li>
							<li id="set_post" class="mui-table-view-cell mui-collapse">
		                        <a class="mui-navigate-right">发布权限 
		                        	<span id="post_text" data-name="text" class="mui-pull-right"></span>
		                        </a>
		                        <div class="mui-collapse-content">
		                        	<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>管理员</label>
										<input data-type="1" name="radio_post" type="radio">
									</div>
									<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>所有人</label>
										<input data-type="0" name="radio_post" type="radio">
									</div>
		                        </div>
		                    </li>
							<li id="set_intro" class="mui-table-view-cell">
		                        <a class="mui-navigate-right">介绍 </a>
		                        <p data-name="text" class="base-content-1"></p>
		                    </li>
						</ul>
						<p></p>
						<ul id="pri_setting" class="mui-table-view" style="display: ;">
							<li id="set_join" class="mui-table-view-cell mui-collapse">
		                        <a class="mui-navigate-right">加入方式
		                        	<span id="join_text" data-name="text" class="mui-pull-right"></span>
		                        </a>
		                        <div class="mui-collapse-content">
		                        	<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>积分付费</label>
										<input data-type="1" name="radio_join" type="radio">
									</div>
									<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>管理员审核</label>
										<input data-type="0" name="radio_join" type="radio">
									</div>
		                        </div>
		                    </li>
		                    <priview id="pri_jion">
								<li id="set_score_type" class="mui-table-view-cell">
			                        <a class="mui-navigate-right">积分类型
			                        	<span data-name="text" class="mui-pull-right"></span>
			                        </a>
			                    </li>
								<li id="set_score" class="mui-table-view-cell">
			                        <a class="mui-navigate-right">加入费用
			                        	<span id="score_text" data-name="text" class="mui-pull-right"></span>
			                        </a>
			                   	</li>
		                    </priview>
							<li id="set_visible" class="mui-table-view-cell mui-collapse">
		                        <a class="mui-navigate-right">浏览模式 
		                        	<span id="visible_text" data-name="text" class="mui-pull-right"></span>
		                        </a>
		                         <div class="mui-collapse-content">
		                        	<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>私密</label>
										<input data-type="1" name="radio_visible" type="radio">
									</div>
									<div class="mui-input-row mui-radio mui-left app-grid mui-col-xs-6">
										<label>公开</label>
										<input data-type="0" name="radio_visible" type="radio">
									</div>
		                        </div>
		                    </li>
		                    <li class="mui-table-view-divider">选择私密，所有内容都不会出现在全站动态</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<!--成员审核页面-->
		<div id="member_check_page" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">成员审核</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul id="check_user_list" class="mui-table-view mui-clearfix"></ul>
					</div>
				</div>
			</div>
		</div>
		<!--成员管理页面-->
		<div id="member_page" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">成员管理</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper event-wrapper">
					<div class="mui-scroll">
						<div id="admin_area">
							<div class="base-info-view">管理员</div>
							<ul id="admin_user_list" class="mui-table-view mui-clearfix"></ul>
							<p></p>
						</div>
						<div class="base-info-view">普通成员</div>
						<ul id="normal_user_list" class="mui-table-view mui-clearfix"></ul>
					</div>
				</div>
			</div>
			
			
		</div>
		<!--邀请好友页面-->
		<div id="invite_page" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">邀请好友</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper event-wrapper">
					<div class="mui-scroll">
						<ul id="invite_user_list" class="mui-table-view"></ul>
					</div>
				</div>
			</div>
		</div>
		
		
				
		<!--成员管理actionsheet-->
		<div id="member_pop" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul id="pop_ul" class="mui-table-view"></ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<b>取消</b>
				</li>
			</ul>
		</div>

		<!--管理面板-->
		<script id="mb_pop_tpl" type="text/html">
			<li id="member_set_score" class="mui-table-view-cell">修改贡献值</li>
			<li id="member_del" class="mui-table-view-cell">成员移除</li>
			<li id="member_set_admin" data-perm="{{position}}" data-type="{{is_normal}}" class="mui-table-view-cell">{{is_normal?'提升为管理员':'撤销管理员'}}</li>
			<li id="member_set_auth" data-perm="{{position}}" class="mui-table-view-cell">圈子转让</li>
		</script>
		
		<!--成员管理用户模板-->
		<script id="manage_user_tpl" type="text/html">
			<a class="mui-navigate-right">
				<div class="app-grid">
					<img data-uid="{{user.uid}}" onload="load(this)" class="user-flag {{if position==1}}base-cir{{else}}base-round{{/if}} base-img-small" onload="" data-src="{{user.avatar128}}" src="../../images/default_avatar.jpg" />
				</div>
				<div class="app-grid mui-col-xs-8">
					<div class="base-flex">
						{{if position==3}}
							<div class="base-tag-1">创建者</div>
						{{else if position==2}}
							<div class="base-tag-1 base-ok-label">管理员</div>
						{{/if}}
						<div class="mui-ellipsis">{{user.nickname}}</div>
					</div>
					<h5 class="base-content-1">
						贡献 {{contribution}}
					</h5>
				</div>
			</a>
		</script>
		
		<!--成员审核用户模板-->
		<script id="check_user_tpl" type="text/html">
			<div class="app-grid">
				<img data-uid="{{user.uid}}" class="user-flag base-cir base-img-small" onload="load(this)" data-src="{{user.avatar128}}" src="../../images/default_avatar.jpg" />
			</div>
			<div class="app-grid mui-col-xs-8">
				<div class="mui-ellipsis">{{user.nickname}}</div>
				<h5 class="base-content-1 mui-ellipsis">
					申请加入圈子
				</h5>
			</div>
			<div class="item-right-text">
				<button type="button" class="event-check mui-btn mui-btn-success mui-btn-outlined">审核</button>
			</div>
		</script>
		
		<!--邀请用户模板-->
		<script id="invite_user_tpl" type="text/html">
			<div class="app-grid">
				<img data-uid="{{uid}}" class="user-flag base-cir base-img-small" onload="load(this)" data-src="{{avatar128}}" src="../../images/default_avatar.jpg" />
			</div>
			<div class="app-grid mui-col-xs-8">
				<div class="mui-ellipsis">{{nickname||'匿名'}}</div>
				<h5 class="base-content-1 mui-ellipsis">
					{{signature||'还没有个性签名'}}
				</h5>
			</div>
			<div class="item-right-text">
				{{if crowd_follow}}
				<span class="base-followed-btn">已加入</span>{{else}}
				<i class="event-invite invite-btn icon-plus"></i>{{/if}}
			</div>
		</script>
		
		<script src="../../js/mui.min.js"></script>
        <script src="html5plus://ready"></script>
		<script src="../../js/mui/mui.view.js"></script>
		<script src="../../js/template.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.pullToRefresh.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.pullToRefresh.material.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../libs/imgtools/md5.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../libs/imgtools/imgload.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mytools/img_uploder.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/core.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/weibo.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../ucenter/js/ucenter.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../libs/widget/widget.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init({
				gestureConfig:{
					longtap:true,
					hold:true				
				}
			});
			
			var viewApi,myView, selfWeb,crowdInfo,myUid = null;
			var btnArray = ['确定', '取消'];
			var changed = false;
			var titleView = document.getElementById("crowd_title");
			var dismBtn = document.getElementById("dismiss");
			
			selfWeb = plus.webview.currentWebview();
			crowdInfo = selfWeb.data;
			titleView.innerText = crowdInfo.title;
		    weibo.getCrowdInfo(crowdInfo.id,function(res){
				if(res.data){
				 	crowdInfo = res.data;
					init_notice();
	 				init_info();
				}else{
				 	toast.info('圈子信息获取失败!');
				}
			})
			
			//初始化单页view
			viewApi = mui('#manage_page').view({
				defaultPage: '#center_page'
			});
			myView = viewApi.view;
			//处理view的后退与webview后退
			var oldBack = mui.back;
			mui.back = function() {
				if (viewApi.canBack()) {
					viewApi.back();
				} else {
					if(changed){
						crowdInfo.is_change = changed;
						var webArr = plus.webview.all();
						for(var i in webArr){
							var tmpWeb = webArr[i];
							if(~tmpWeb.id.indexOf('crowd')){
								mui.fire(tmpWeb,'crowdChange',{data:crowdInfo});
							}
						}
					}
					oldBack();
				}
			};

			mui('.mui-scroll-wrapper').scroll({
				bounce:false
			});
			
			/*解散圈子*/
			dismBtn.addEventListener('tap',function(e){
				mui.prompt('您正在解散圈子，请输入圈子名称','', '验证提示', btnArray, function(e) {
					if (e.index == 0 && e.value.trim()) {
						weibo.delCrowd({id:crowdInfo.id,verify:e.value},function(res){
							toast.info(res.info);
							if(res.code == 200){
								changed = 2;
								mui.back();
							}
						})
					}
				})
			})
			
			/**
			 * notice_page页面
			 */
			var noticeView = {
				content:document.getElementById("notice_content_view"),
				submit:document.getElementById("notice_submit_btn")
			};
			//初始化公告页面
			var init_notice = function(){
				noticeView.content.placeholder = crowdInfo.notice||'发布一条新公告';
			}

			//修改公告
			noticeView.submit.addEventListener('tap',function(e){
				if(!noticeView.content.value.trim())return;
				weibo.setCrowdInfo({
					id:crowdInfo.id,
					notice:noticeView.content.value
				},function(res){
					toast.info(res.info);
					if(res.data){
						crowdInfo = res.data;
						init_notice();						
					}
					mui.back();
				})
			})
			
			
			/**
			 * info_page页面开始
			 */
			var scoreTypes = app.getConfig('system').score_list;
			var infoView = {
				reqInfo:{},
				typeObj:{0:'公开',1:'私密'},
				postObj:{0:'所有人',1:'管理员'},
				joinObj:{0:'管理员审核',1:'积分付费'},
				scoreObj:app.getScoreObj(scoreTypes),
				logo:document.getElementById("set_logo"),
				title:document.getElementById("set_title"),
				type:document.getElementById("set_type"),
				type_text:document.getElementById("type_text"),
				post: document.getElementById("set_post"),
				post_text: document.getElementById("post_text"),
				intro:document.getElementById("set_intro"),
				pri_view:document.getElementById("pri_setting"),
				join:document.getElementById("set_join"),
				join_text:document.getElementById("join_text"),
				pri_jion:document.getElementById("pri_jion"),
				score:document.getElementById("set_score"),
				score_text:document.getElementById("score_text"),
				score_type:document.getElementById("set_score_type"),
				visible:document.getElementById("set_visible"),
				visible_text:document.getElementById("visible_text"),
			};
			
			//初始化info页面
			function init_info(){
				titleView.innerText = crowdInfo.title;
				infoView.reqInfo = {id:crowdInfo.id};
				infoView.logo.src = crowdInfo.logo;
				infoView.title.querySelector('[data-name="text"]').innerText = crowdInfo.title;
				infoView.intro.querySelector('[data-name="text"]').innerText = crowdInfo.intro;
				infoView.pri_view.style.display = crowdInfo.type == 1?'block':'none';
				infoView.pri_jion.style.display = crowdInfo.need_pay>0?'block':'none';
				infoView.score.querySelector('[data-name="text"]').innerText = crowdInfo.need_pay;
				infoView.score_type.querySelector('[data-name="text"]').innerText = infoView.scoreObj[crowdInfo.pay_type]||scoreTypes[0].title;
				infoView.type.querySelector('[data-name="text"]').innerText = infoView.typeObj[crowdInfo.type];
				if(crowdInfo.type == 1){
					infoView.type.querySelector('input[data-type="1"]').checked = true;
				}else{
					infoView.type.querySelector('input[data-type="0"]').checked = true;
				}
				var postTag = crowdInfo.allow_user_post == 0?'0':'1';
				infoView.post.querySelector('[data-name="text"]').innerHTML = infoView.postObj[postTag];
				if(crowdInfo.allow_user_post == 0){
					infoView.post.querySelector('input[data-type="0"]').checked = true;
				}else{
					infoView.post.querySelector('input[data-type="1"]').checked = true;
				}
				var joinTag = crowdInfo.need_pay ==0 && crowdInfo.pay_type ==0?'0':'1';
				infoView.join.querySelector('[data-name="text"]').innerHTML = infoView.joinObj[joinTag];
				if(crowdInfo.need_pay ==0 && crowdInfo.pay_type ==0){
					infoView.join.querySelector('input[data-type="0"]').checked = true;
				}else{
					infoView.join.querySelector('input[data-type="1"]').checked = true;
				}
	
				infoView.visible.querySelector('[data-name="text"]').innerHTML = infoView.typeObj[crowdInfo.invisible];
				if(crowdInfo.invisible == 0){
					infoView.visible.querySelector('input[data-type="0"]').checked = true;
				}else{
					infoView.visible.querySelector('input[data-type="1"]').checked = true;
				}
			}
			
			//执行资料修改请求
			var doSetInfo = function(){
				var waitView = plus.nativeUI.showWaiting('执行中..');
				weibo.setCrowdInfo(infoView.reqInfo,function(res){
					waitView.close();
					toast.info(res.info);
					if(res.data){
						crowdInfo = res.data;
						changed = 1;
					}
					init_info();
				})
			}

			//更换封面
			infoView.logo.addEventListener('tap',function(e){
				plus.gallery.pick(function(localPath) {
					infoView.logo.src = localPath;
					ImgLoader().getImgInfo(localPath,function(imgInfo){
						UploaderTool().doUp(imgInfo.url,function(res){
							if(res.data){
								infoView.reqInfo.logo = res.data.id;
								doSetInfo();
							}
						})
					})
				});
			})
			//修改圈名
			infoView.title.addEventListener('tap',function(e){
				mui.prompt('提示：字数不得超过15字！', crowdInfo.title, '修改圈名', btnArray, function(e) {
					if (e.index == 0) {
						infoView.reqInfo.title = e.value;
						doSetInfo();
					}
				})
				return false;
			})
			//修改圈子介绍
			infoView.intro.addEventListener('tap',function(e){
				mui.prompt('圈子的简单信息', '介绍内容', '修改圈子介绍', btnArray, function(e) {
					if (e.index == 0) {
						infoView.reqInfo.intro = e.value;
						doSetInfo();
					}
				})
				return false;
			})
			
			mui('#info_page').on('change','input',function(e){
				var parentId = get_parent_node(this,'li').id;
				var typeData = this.getAttribute('data-type');
				switch(parentId){
					case 'set_type'://圈子类型选择
						infoView.reqInfo.type = typeData +1;
						break;
					case 'set_post'://圈子发布权限选择
						infoView.reqInfo.allow = typeData +1;
						break;
					case 'set_visible'://圈子动态浏览模式选择
						infoView.reqInfo.visible = typeData +1;
						break;
					case 'set_join'://圈子加入方式选择
						if(typeData == 1 && crowdInfo.need_pay == 0){
							widget.scorePanel(scoreTypes,function(score){
								if(score){
									infoView.reqInfo.pay_type = score.id;
									mui.prompt('加入圈子需要交纳的积分费用','', '加入费用', btnArray, function(e) {
										if (e.index == 0 && e.value > 0) {
											infoView.reqInfo.join_type = typeData +1;
											infoView.reqInfo.score = e.value;
											doSetInfo();
										}else{
											init_info();
										}
									})
								}else{
									init_info();
								}
							});
						}else if(typeData == 0 && crowdInfo.need_pay >0){
							infoView.reqInfo.join_type = typeData +1;
							doSetInfo();
						}
						return;
				}
				doSetInfo();
			})
			//修改入圈积分类型
			infoView.score_type.addEventListener('tap',function(e){
				widget.scorePanel(scoreTypes,function(score){
					if(score){
						infoView.reqInfo.pay_type = score.id;
						doSetInfo();
					}
				});
			})
			//修改入圈费用
			infoView.score.addEventListener('tap',function(e){
				var numb = parseInt(infoView.score_text.innerHTML);
				mui.prompt('加入圈子需要交纳的积分费用', numb, '加入费用', btnArray, function(e) {
					if (e.index == 0) {
						infoView.reqInfo.score = e.value;
						doSetInfo();
					}
				})
				return false;
			})
			//info_page页面结束
			
			/**
			 * member_check_page页面
			 */
			var checkListView = document.getElementById("check_user_list");
			
			//审核操作
			mui('#member_check_page').on('tap','.event-check',function(e){
				var itemView = get_parent_node(this,'li');
				var mbInfo = itemView.detail_info;
				plus.nativeUI.actionSheet({
					title:"审核操作",
					cancel:"取消",
					buttons:[{title:"通过"},{title:"拒绝"}]
				}, function(e){
					var rstInfo = {id:crowdInfo.id,uid:mbInfo.uid};
					if(e.index > 0){
						rstInfo.flag = e.index == 1?1:0;
						weibo.checkCrowdMember(rstInfo,function(res){
							toast.info(res.info);
							if(res.code == 200){
								checkListView.removeChild(itemView);
							}
						})
					}
				});
			})
			//member_check_page页面结束
			
			/**
			 * invite_page页面开始
			 */
			var inviteView = {
				userRqst: {
					uid:is_login(),
					type:3,
					page:0
				},
				mbIds:null,
				userListView:document.getElementById("invite_user_list"),
				addView:function(list){
					if(!inviteView.mbIds){
						inviteView.mbIds = ','+ crowdInfo.member_ids.toString() +',';
					}
					for(var i in list){
						var tmpUser = list[i];
						if(inviteView.mbIds.match(','+tmpUser.uid+',')){
							tmpUser.crowd_follow = 1;
						}
					 	var item = app.createListItem(tmpUser,'mui-table-view-cell');
					 	item.innerHTML = template('invite_user_tpl',tmpUser);
						inviteView.userListView.appendChild(item);
					}
				}
			};

			mui('#invite_page .mui-scroll').pullToRefresh({
				down: {
					callback: function() {
						inviteView.userRqst.page = 1;
						var selfPull = this;
						ucenter.getUserList(inviteView.userRqst, function(res) {
							inviteView.userListView.innerHTML = '';
							inviteView.addView(res.data);

							//重置底部加载状态
							selfPull.refresh(res.data&&res.data.length>=10);
							selfPull.endPullDownToRefresh();
						})
					}
				},
				up: {
					callback: function() {
						inviteView.userRqst.page++;
						var selfPull = this;
						ucenter.getUserList(inviteView.userRqst, function(res) {
							inviteView.addView(res.data);
							selfPull.endPullUpToRefresh(!res.data||res.data.length<10);
						});
					}
				}
			})
			
			//邀请按钮
			mui('#invite_page').on('tap','.event-invite',function(e){
				var thisView = this;
				var uInfo = get_parent_node(this,'li').detail_info;
				weibo.manageCrowdUser({
					id:crowdInfo.id,
					uid:uInfo.uid,
					flag:'add'
				},function(res){
					toast.info(res.info);
					if(res.code == 200){
						inviteView.mbIds = inviteView.mbIds + uInfo.uid+',';
						thisView.parentNode.innerHTML = '<span class="base-followed-btn">已加入</span>';
					}
				})
			});
			//invite_page页面结束
			
			
			/**
			 * member_pag页面
			 */
			var mb ={
				rqstInfo:{id:crowdInfo.id,flag:'normal',page:0},
				item:null,
				popView: document.getElementById("member_pop"),
				ul: document.getElementById("pop_ul"),
				adminListView:document.getElementById("admin_user_list"),
				normalListView: document.getElementById("normal_user_list"),
				scoreBtn: document.getElementById("member_set_score"),
				delBtn: document.getElementById("member_del"),
				adminBtn: document.getElementById("member_set_admin"),
				authBtn: document.getElementById("member_set_auth"),
				addView:function(list){
					for(var i in list){
						var tmpUser = list[i];
					 	var item = app.createListItem(tmpUser,'mui-table-view-cell');
					 	item.innerHTML = template('manage_user_tpl',tmpUser);
						mb.normalListView.appendChild(item);
					}
				}
			}
			
			mui('#member_page .mui-scroll').pullToRefresh({
				down: {
					callback: function() {
						mb.rqstInfo.page = 1;
						var selfPull = this;
						weibo.getCrowdUser(mb.rqstInfo, function(res) {
							mb.normalListView.innerHTML = '';
							mb.addView(res.data);

							//重置底部加载状态
							selfPull.refresh(res.data&&res.data.length>=10);
							selfPull.endPullDownToRefresh();
						})
					}
				},
				up: {
					callback: function() {
						mb.rqstInfo.page ++;
						var selfPull = this;
						weibo.getCrowdUser(mb.rqstInfo, function(res) {
							mb.addView(res.data);
							selfPull.endPullUpToRefresh(!res.data||res.data.length<10);
						});
					}
				}
			})
			
			//listView装载器
			function render_member_list(listView,type,tpl){
				tpl = tpl||'manage_user_tpl';
				weibo.getCrowdUser({id:crowdInfo.id,flag:type},function(res){
					for(var i in res.data){
					 	var tmpUser = res.data[i];
					 	var item = app.createListItem(tmpUser,'mui-table-view-cell');
					 	item.innerHTML = template(tpl,tmpUser);
					 	listView.appendChild(item);
				 	}
				})
			}

			/*圈子成员管理*/
			mui('#member_page').on('tap','li',function(e){
				if(e.target.tagName == 'IMG')return;
				mb.item = this;
				var info = mb.item.detail_info;
				if(crowdInfo.uid == info.uid){
					mb.ul.innerHTML = '<li id="member_set_score" class="mui-table-view-cell">修改贡献值</li>';
				}else{
					crowdInfo.is_normal = info.position==1?1:0;
					mb.ul.innerHTML = template('mb_pop_tpl',crowdInfo);
				}
				mui('#member_pop').popover('toggle');
			});
			
			/*成员管理面板*/
			mui('body').on('tap','.mui-popover-action li',function(e){
				mui('#member_pop').popover('toggle');
				var uInfo = mb.item.detail_info;
				var typeId = this.id;
				var rstInfo = {
					id:crowdInfo.id,
					uid:uInfo.uid
				}
				switch(typeId){
					case 'member_set_score':	//设置贡献
						mui.prompt('请输入修改后的数值', '贡献值', '修改贡献值', btnArray, function(e) {
							if (e.index == 0) {
								rstInfo.score = e.value;
								weibo.setCrowdScore(rstInfo,function(res){
									toast.info(res.info);
									if(res.code == 200){
										mui('#member_page .mui-scroll').pullToRefresh().pullDownLoading();
									}
								})
							}
						})
						break;
					case 'member_del':		//移除成员
						mui.confirm('确认移除成员‘Nick’？','移除提示',btnArray,function(e){
							if(e.index == 0){
								rstInfo.flag = 'remove';
								weibo.manageCrowdUser(rstInfo,function(res){
									toast.info(res.info);
									if(res.code == 200){
										mui('#member_page .mui-scroll').pullToRefresh().pullDownLoading();
									}
								})
							}
						})
						break;
					case 'member_set_admin':		//设置管理员
						if(uInfo.position == 1){
							rstInfo.flag = 1;
							weibo.setCrowdAdmin(rstInfo,function(res){
								toast.info(res.info);
								if(res.code == 200){
									mb.adminListView.innerHTML = '';
									render_member_list(mb.adminListView,'admin');
								}
							})
						}else{
							rstInfo.flag = 0;
							mui.confirm('确认撤销目标的管理员权限', '撤销提示', btnArray, function(e) {
								if (e.index == 0) {
									weibo.setCrowdAdmin(rstInfo,function(res){
										toast.info(res.info);
										if(res.code == 200){
											mui('#member_page .mui-scroll').pullToRefresh().pullDownLoading();
										}
									})
								}
							})
						}
						break;
					case 'member_set_auth':		//圈子转让
						mui.confirm('确认把圈子转移给目标?您将失去圈子的所有权，变为普通成员!', '转移提示', btnArray, function(e) {
							if (e.index == 0) {
								weibo.setCrowdAuth(rstInfo,function(res){
									toast.info(res.info);
									if(res.code == 200){
										oldBack();
									}
								})
							}
						})
						break;
					default:
						break;
				}
			});
			//用户中心监听器
			app.userListener();
			//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
			//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
			myView.addEventListener('pageShow', function(e) {
				console.log(e.detail.page.id + ' show');
				switch(e.detail.page.id){
					case 'member_check_page':
						checkListView.innerHTML = '';
						render_member_list(checkListView,'check','check_user_tpl');
						break;
					case 'invite_page':
						if(!inviteView.userListView.children.length){
							mui('#invite_page .mui-scroll').pullToRefresh().pullDownLoading();
						}
						break;
					case 'member_page':
						if(crowdInfo.permission == 3){
							mb.adminListView.innerHTML = '';
							render_member_list(mb.adminListView,'admin');
						}else{
							document.getElementById("admin_area").style.display = 'none';
						}
						mui('#member_page .mui-scroll').pullToRefresh().pullDownLoading();
						break;
				}
			});
		</script>
	</body>

</html>